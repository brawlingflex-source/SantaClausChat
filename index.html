<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>–î–µ–¥ –ú–æ—Ä–æ–∑ ‚Äî –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π —á–∞—Ç</title>
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Arial', sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(145deg, #0b2b3f 0%, #1b4f6e 100%);
      position: relative;
      overflow-x: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    /* –°–Ω–µ–∂–∏–Ω–∫–∏ (–ø—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è) */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.3"><circle cx="10" cy="10" r="2" fill="white"/><circle cx="85" cy="30" r="2.5" fill="white"/><circle cx="40" cy="80" r="2" fill="white"/><circle cx="70" cy="70" r="1.8" fill="white"/><circle cx="20" cy="50" r="2.2" fill="white"/></svg>');
      background-size: 200px 200px;
      pointer-events: none;
      animation: snow 40s linear infinite;
      z-index: 0;
    }

    @keyframes snow {
      0% { background-position: 0 0; }
      100% { background-position: 200px 200px; }
    }

    .container {
      position: relative;
      z-index: 2;
      width: 100%;
      max-width: 1300px;
      height: 90vh;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 40px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.3);
      overflow: hidden;
      padding: 15px;
    }

    /* –≠–∫—Ä–∞–Ω—ã */
    .screen {
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
    }

    .active-screen {
      display: flex;
    }

    /* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω */
    #welcome-screen {
      justify-content: center;
      align-items: center;
      text-align: center;
      color: white;
    }

    .welcome-card {
      background: rgba(0, 20, 40, 0.7);
      backdrop-filter: blur(8px);
      padding: 40px 30px;
      border-radius: 60px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 50px rgba(0, 200, 255, 0.6);
      max-width: 500px;
      width: 100%;
    }

    .glow-text {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 30px;
      text-shadow: 0 0 10px cyan, 0 0 20px blue, 0 0 30px darkblue;
      animation: glowPulse 2s infinite;
    }

    @keyframes glowPulse {
      0% { text-shadow: 0 0 10px white, 0 0 20px cyan, 0 0 30px blue; }
      50% { text-shadow: 0 0 20px yellow, 0 0 40px orange, 0 0 60px red; }
      100% { text-shadow: 0 0 10px white, 0 0 20px cyan, 0 0 30px blue; }
    }

    .welcome-input {
      width: 100%;
      padding: 18px 25px;
      font-size: 1.2rem;
      border: none;
      border-radius: 60px;
      background: rgba(255, 255, 255, 0.9);
      margin-bottom: 20px;
      outline: 3px solid #ffd966;
    }

    .btn {
      padding: 16px 40px;
      font-size: 1.3rem;
      font-weight: bold;
      border: none;
      border-radius: 50px;
      background: linear-gradient(45deg, #ff4d4d, #ff9f4d);
      color: white;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      transition: 0.2s;
      border: 1px solid rgba(255,255,255,0.5);
    }

    .btn:active { transform: scale(0.95); }

    /* –ß–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–∏–Ω—è—è —Ç–µ–º–∞) */
    .chat-header {
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(0, 50, 80, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 30px 30px 15px 15px;
      color: white;
      margin-bottom: 15px;
    }

    .chat-header .avatar {
      width: 50px;
      height: 50px;
      background: #c43e3e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-right: 15px;
      border: 2px solid gold;
    }

    .chat-header .info { flex: 1; }

    .chat-header .name { font-size: 1.5rem; font-weight: bold; }

    .chat-header .status { font-size: 0.9rem; opacity: 0.8; }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 30px;
      margin-bottom: 15px;
      scroll-behavior: smooth;
    }

    /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    .messages-container::-webkit-scrollbar { width: 6px; }
    .messages-container::-webkit-scrollbar-thumb { background: gold; border-radius: 10px; }

    .message {
      display: flex;
      margin-bottom: 15px;
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message.sent {
      justify-content: flex-end;
    }

    .message .bubble {
      max-width: 75%;
      padding: 12px 18px;
      border-radius: 25px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .message.sent .bubble {
      background: #1e5f8e;
      color: white;
      border-bottom-right-radius: 5px;
    }

    .message.received .bubble {
      background: #3a5f6e;
      color: white;
      border-bottom-left-radius: 5px;
    }

    .message .time {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 5px;
      text-align: right;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ffaaaa;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 8px;
      opacity: 0.5;
      transition: 0.2s;
      display: inline-flex;
      align-items: center;
    }

    .delete-btn:hover { opacity: 1; color: red; }

    .date-divider {
      text-align: center;
      margin: 15px 0;
      font-size: 0.85rem;
      color: #ffd966;
      background: rgba(0,0,0,0.4);
      padding: 5px;
      border-radius: 30px;
    }

    .typing-indicator {
      font-style: italic;
      color: #b0e0ff;
      padding: 8px 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 30px;
      margin-bottom: 5px;
      display: none;
    }

    .input-area {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: rgba(0, 30, 50, 0.8);
      border-radius: 50px;
      backdrop-filter: blur(5px);
    }

    .input-area input {
      flex: 1;
      padding: 16px 20px;
      border: none;
      border-radius: 50px;
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 1rem;
      outline: 2px solid #ffbf00;
    }

    .input-area input::placeholder { color: #ddd; }

    .input-area button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: gold;
      font-size: 1.5rem;
      cursor: pointer;
      transition: 0.2s;
    }

    .input-area button:active { background: #ffd966; }

    /* –ü–∞–Ω–µ–ª—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (–∫—Ä–∞—Å–Ω–∞—è) */
    .santa-panel {
      display: flex;
      flex-direction: row;
      height: 100%;
      gap: 15px;
    }

    .users-sidebar {
      width: 280px;
      background: rgba(120, 20, 20, 0.7);
      backdrop-filter: blur(8px);
      border-radius: 30px;
      padding: 15px;
      overflow-y: auto;
      color: white;
      border: 2px solid #ffb347;
    }

    .users-sidebar h3 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 20px;
      text-shadow: 0 0 10px gold;
    }

    .user-item {
      padding: 15px;
      margin-bottom: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 25px;
      border-left: 8px solid #ffc107;
      cursor: pointer;
      transition: 0.2s;
    }

    .user-item:hover { background: rgba(0,0,0,0.6); }
    .user-item.active { background: #8b0000; border-left-color: white; }

    .user-name {
      font-weight: bold;
      font-size: 1.3rem;
    }

    .user-lastseen {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .santa-chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(100, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      border-radius: 30px;
      padding: 15px;
      border: 2px solid #ff6347;
    }

    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 700px) {
      .santa-panel {
        flex-direction: column;
      }
      .users-sidebar {
        width: 100%;
        height: 200px;
      }
      .welcome-card { padding: 20px; }
      .glow-text { font-size: 1.5rem; }
    }

    /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */
    .logout-btn {
      background: #722f2f;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 15px;
      border: 1px solid white;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
  <div id="welcome-screen" class="screen active-screen">
    <div class="welcome-card">
      <div class="glow-text">‚ú® –ù–∞—á–Ω–∏ –æ–±—â–µ–Ω–∏–µ —Å –î–µ–¥–æ–º –ú–æ—Ä–æ–∑–æ–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! ‚ú®</div>
      <input type="text" id="username-input" class="welcome-input" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ—ë –∏–º—è..." autocomplete="off">
      <button class="btn" id="start-chat-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è / –ø–∞–Ω–µ–ª—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞) -->
  <div id="app-screen" class="screen">
    <!-- –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="user-chat" class="screen" style="display: none;">
      <div class="chat-header">
        <div class="avatar">üéÖ</div>
        <div class="info">
          <div class="name">–î–µ–¥ –ú–æ—Ä–æ–∑</div>
          <div class="status" id="user-santa-status">–æ–Ω–ª–∞–π–Ω</div>
        </div>
        <button class="logout-btn" id="logout-from-user">–í—ã–π—Ç–∏</button>
      </div>
      <div class="typing-indicator" id="user-typing-indicator">–î–µ–¥ –ú–æ—Ä–æ–∑ –ø–µ—á–∞—Ç–∞–µ—Ç...</div>
      <div class="messages-container" id="user-messages"></div>
      <div class="input-area">
        <input type="text" id="user-message-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ..." autocomplete="off">
        <button id="user-send-btn">üì®</button>
      </div>
    </div>

    <!-- –î–ª—è –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ -->
    <div id="santa-panel" class="screen" style="display: none;">
      <div class="santa-panel">
        <div class="users-sidebar">
          <h3>üéÑ –î–µ—Ç–∏ üéÑ</h3>
          <div id="users-list"></div>
          <button class="logout-btn" id="logout-from-santa" style="width:100%; margin-top:15px;">–í—ã–π—Ç–∏</button>
        </div>
        <div class="santa-chat-area">
          <div class="chat-header" style="background:#7a1f1f;">
            <div class="avatar" style="background: darkred;">üë§</div>
            <div class="info">
              <div class="name" id="santa-current-chat-name">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
              <div class="status" id="santa-current-chat-status"></div>
            </div>
          </div>
          <div class="typing-indicator" id="santa-typing-indicator">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç...</div>
          <div class="messages-container" id="santa-messages"></div>
          <div class="input-area">
            <input type="text" id="santa-message-input" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..." autocomplete="off" disabled>
            <button id="santa-send-btn" disabled>üéÅ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    // ---------- –ö–æ–Ω—Ñ–∏–≥ Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAu_wfaRhTsWNbsyFYmEigopqJck7ynxlU",
      authDomain: "messeger-0wo2h4.firebaseapp.com",
      databaseURL: "https://messeger-0wo2h4-default-rtdb.firebaseio.com",
      projectId: "messeger-0wo2h4",
      storageBucket: "messeger-0wo2h4.firebasestorage.app",
      messagingSenderId: "1057251395030",
      appId: "1:1057251395030:web:86f8f718ed938055e29077"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ----------
    let currentUserId = null;            // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—ã—á–Ω–æ–≥–æ –∏–ª–∏ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞)
    let currentUserName = null;          // –∏–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let isSanta = false;                 // —Ñ–ª–∞–≥, —á—Ç–æ –≤–æ—à–ª–∏ –∫–∞–∫ –î–µ–¥ –ú–æ—Ä–æ–∑
    let santaId = null;                  // ID –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (—É–∑–Ω–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
    let selectedUserId = null;           // –¥–ª—è –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ ‚Äî —Å –∫–µ–º —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç
    let typingTimeouts = {};              // –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π –ø–µ—á–∞—Ç–∏

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const welcomeScreen = document.getElementById('welcome-screen');
    const appScreen = document.getElementById('app-screen');
    const userChatDiv = document.getElementById('user-chat');
    const santaPanelDiv = document.getElementById('santa-panel');
    const usernameInput = document.getElementById('username-input');
    const startBtn = document.getElementById('start-chat-btn');

    // –≠–ª–µ–º–µ–Ω—Ç—ã —á–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMessagesDiv = document.getElementById('user-messages');
    const userInput = document.getElementById('user-message-input');
    const userSendBtn = document.getElementById('user-send-btn');
    const userTypingIndicator = document.getElementById('user-typing-indicator');
    const userSantaStatus = document.getElementById('user-santa-status');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
    const usersListDiv = document.getElementById('users-list');
    const santaCurrentChatName = document.getElementById('santa-current-chat-name');
    const santaCurrentChatStatus = document.getElementById('santa-current-chat-status');
    const santaMessagesDiv = document.getElementById('santa-messages');
    const santaInput = document.getElementById('santa-message-input');
    const santaSendBtn = document.getElementById('santa-send-btn');
    const santaTypingIndicator = document.getElementById('santa-typing-indicator');

    // –ö–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞
    document.getElementById('logout-from-user').addEventListener('click', logout);
    document.getElementById('logout-from-santa').addEventListener('click', logout);

    // ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------
    function logout() {
      localStorage.removeItem('santaChatUserId');
      localStorage.removeItem('santaChatUserName');
      localStorage.removeItem('santaChatIsSanta');
      window.location.reload();
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ –ú–°–ö
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Moscow' });
    }

    function formatDateLine(timestamp) {
      const date = new Date(timestamp);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      if (date.toDateString() === today.toDateString()) return '–°–µ–≥–æ–¥–Ω—è';
      if (date.toDateString() === yesterday.toDateString()) return '–í—á–µ—Ä–∞';
      return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–∑–∏—Ç–∞ –¥–ª—è –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
    function formatLastSeen(timestamp) {
      if (!timestamp) return '–Ω–∏–∫–æ–≥–¥–∞';
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      if (minutes < 60) return `${minutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
      if (hours < 24) {
        const date = new Date(timestamp);
        return `—Å–µ–≥–æ–¥–Ω—è –≤ ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Moscow' })}`;
      }
      if (days === 1) {
        const date = new Date(timestamp);
        return `–≤—á–µ—Ä–∞ –≤ ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Moscow' })}`;
      }
      return new Date(timestamp).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Moscow' });
    }

    // –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏, –≤–µ—Ä–Ω—É—Ç—å ID
    async function getOrCreateUser(name) {
      const usersRef = db.ref('users');
      const snapshot = await usersRef.orderByChild('name').equalTo(name).once('value');
      if (snapshot.exists()) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const entries = Object.entries(snapshot.val());
        const first = entries[0];
        return { id: first[0], ...first[1] };
      } else {
        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ
        const newUserRef = usersRef.push();
        const newUser = {
          name: name,
          lastSeen: Date.now(),
          isSanta: (name.toLowerCase() === '–¥–µ–¥ –º–æ—Ä–æ–∑') // –µ—Å–ª–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –î–µ–¥ –ú–æ—Ä–æ–∑
        };
        await newUserRef.set(newUser);
        return { id: newUserRef.key, ...newUser };
      }
    }

    // –ü–æ–ª—É—á–∏—Ç—å ID –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (—Å–æ–∑–¥–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç)
    async function ensureSanta() {
      const usersRef = db.ref('users');
      const snapshot = await usersRef.orderByChild('name').equalTo('–î–µ–¥ –ú–æ—Ä–æ–∑').once('value');
      if (snapshot.exists()) {
        const entries = Object.entries(snapshot.val());
        const first = entries[0];
        santaId = first[0];
      } else {
        // –°–æ–∑–¥–∞—ë–º –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
        const newSantaRef = usersRef.push();
        await newSantaRef.set({ name: '–î–µ–¥ –ú–æ—Ä–æ–∑', lastSeen: Date.now(), isSanta: true });
        santaId = newSantaRef.key;
      }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å lastSeen —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function updateLastSeen() {
      if (!currentUserId) return;
      db.ref(`users/${currentUserId}`).update({ lastSeen: Date.now() });
    }

    // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ----------
    async function initApp(userName, userId, santaFlag) {
      currentUserId = userId;
      currentUserName = userName;
      isSanta = santaFlag;
      localStorage.setItem('santaChatUserId', userId);
      localStorage.setItem('santaChatUserName', userName);
      localStorage.setItem('santaChatIsSanta', santaFlag ? 'true' : 'false');

      await ensureSanta(); // —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –î–µ–¥ –ú–æ—Ä–æ–∑ –µ—Å—Ç—å –≤ –±–∞–∑–µ

      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
      welcomeScreen.classList.remove('active-screen');
      appScreen.classList.add('active-screen');

      if (isSanta) {
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
        santaPanelDiv.style.display = 'flex';
        userChatDiv.style.display = 'none';
        loadSantaPanel();
      } else {
        // –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        santaPanelDiv.style.display = 'none';
        userChatDiv.style.display = 'flex';
        loadUserChat();
      }
      updateLastSeen();
    }

    // ---------- –ß–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ----------
    function loadUserChat() {
      if (!santaId) return;
      const chatId = `${currentUserId}_${santaId}`; // –º–æ–∂–Ω–æ –∏ —Ç–∞–∫, –ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
      const messagesRef = db.ref('messages/' + chatId);
      messagesRef.off(); // –æ—á–∏—Å—Ç–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
      messagesRef.on('child_added', (snapshot) => {
        const msg = snapshot.val();
        if (msg.senderId === currentUserId) {
          appendMessageToUser('sent', msg.text, msg.timestamp, snapshot.key);
        } else {
          appendMessageToUser('received', msg.text, msg.timestamp, snapshot.key);
        }
        scrollToBottom(userMessagesDiv);
      });

      // –°–ª—É—à–∞–µ–º –ø–µ—á–∞—Ç–∞–Ω–∏–µ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
      const typingRef = db.ref('typing/' + chatId + '/' + santaId);
      typingRef.on('value', (snap) => {
        if (snap.val()) {
          userTypingIndicator.style.display = 'block';
        } else {
          userTypingIndicator.style.display = 'none';
        }
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
      const sendMessage = () => {
        const text = userInput.value.trim();
        if (!text) return;
        const newMsgRef = messagesRef.push();
        newMsgRef.set({
          text: text,
          senderId: currentUserId,
          timestamp: Date.now()
        });
        userInput.value = '';
        updateLastSeen();
        // –°–±—Ä–æ—Å –ø–µ—á–∞—Ç–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        stopTyping(chatId, currentUserId);
      };
      userSendBtn.onclick = sendMessage;
      userInput.onkeydown = (e) => {
        if (e.key === 'Enter') sendMessage();
      };

      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      userInput.oninput = () => {
        startTyping(chatId, currentUserId);
      };

      // –°—Ç–∞—Ç—É—Å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (–æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω) ‚Äî –ø–æ lastSeen
      const santaUserRef = db.ref('users/' + santaId + '/lastSeen');
      santaUserRef.on('value', (snap) => {
        const last = snap.val();
        if (Date.now() - last < 60000) userSantaStatus.innerText = '–æ–Ω–ª–∞–π–Ω';
        else userSantaStatus.innerText = '–±—ã–ª(–∞) ' + formatLastSeen(last);
      });
    }

    function appendMessageToUser(type, text, timestamp, msgId) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message', type);
      msgDiv.dataset.id = msgId;
      msgDiv.innerHTML = `<div class="bubble">${text}<div class="time">${formatTime(timestamp)}</div></div>`;
      // –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
      userMessagesDiv.appendChild(msgDiv);
    }

    // ---------- –ü–∞–Ω–µ–ª—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ ----------
    function loadSantaPanel() {
      // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫—Ä–æ–º–µ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫–∞
      const usersRef = db.ref('users');
      usersRef.on('value', (snapshot) => {
        const users = snapshot.val() || {};
        const filtered = Object.entries(users).filter(([id, u]) => u.name !== '–î–µ–¥ –ú–æ—Ä–æ–∑' && u.name);
        renderUsersList(filtered);
      });

      // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç
    }

    function renderUsersList(users) {
      usersListDiv.innerHTML = '';
      users.sort((a, b) => (b[1].lastSeen || 0) - (a[1].lastSeen || 0)); // —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ
      for (let [id, user] of users) {
        const item = document.createElement('div');
        item.className = `user-item ${selectedUserId === id ? 'active' : ''}`;
        item.innerHTML = `<div class="user-name">${user.name}</div>
                          <div class="user-lastseen">${formatLastSeen(user.lastSeen)}</div>`;
        item.onclick = () => selectUserChat(id, user.name);
        usersListDiv.appendChild(item);
      }
    }

    function selectUserChat(userId, userName) {
      if (!santaId) return;
      selectedUserId = userId;
      santaCurrentChatName.innerText = userName;
      santaInput.disabled = false;
      santaSendBtn.disabled = false;

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ —Å–ø–∏—Å–∫–µ
      document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
      // –ù–∞–π–¥–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ –∏–º–µ–Ω–∏ (–Ω–µ–∏–¥–µ–∞–ª—å–Ω–æ, –Ω–æ –ø–æ userId —Å–ª–æ–∂–Ω–µ–µ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å data –∞—Ç—Ä–∏–±—É—Ç)
      // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫ —Å –∞–∫—Ç–∏–≤–Ω—ã–º –∫–ª–∞—Å—Å–æ–º —á—É—Ç—å –ø–æ–∑–∂–µ, –Ω–æ –º–æ–∂–Ω–æ –∏ —Ç–∞–∫:
      renderUsersListWithActive(userId);

      const chatId = `${userId}_${santaId}`; // –ø–æ—Ä—è–¥–æ–∫: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å_—Å–∞–Ω—Ç–∞ (–Ω–µ –≤–∞–∂–Ω–æ, –≥–ª–∞–≤–Ω–æ–µ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ)

      // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
      const messagesRef = db.ref('messages/' + chatId);
      messagesRef.off();
      santaMessagesDiv.innerHTML = ''; // –æ—á–∏—Å—Ç–∏—Ç—å
      messagesRef.on('child_added', (snapshot) => {
        const msg = snapshot.val();
        if (msg.senderId === santaId) {
          appendMessageToSanta('sent', msg.text, msg.timestamp, snapshot.key, true); // —Å–≤–æ—ë
        } else {
          appendMessageToSanta('received', msg.text, msg.timestamp, snapshot.key, false);
        }
        scrollToBottom(santaMessagesDiv);
      });

      // –°–ª—É—à–∞–µ–º –ø–µ—á–∞—Ç–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const typingRef = db.ref('typing/' + chatId + '/' + userId);
      typingRef.on('value', (snap) => {
        santaTypingIndicator.style.display = snap.val() ? 'block' : 'none';
      });

      // –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userLastSeenRef = db.ref('users/' + userId + '/lastSeen');
      userLastSeenRef.on('value', (snap) => {
        const last = snap.val();
        santaCurrentChatStatus.innerText = formatLastSeen(last);
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –°–∞–Ω—Ç—ã
      const sendSantaMsg = () => {
        const text = santaInput.value.trim();
        if (!text) return;
        const newMsgRef = messagesRef.push();
        newMsgRef.set({
          text: text,
          senderId: santaId,
          timestamp: Date.now()
        });
        santaInput.value = '';
        updateLastSeen();
        stopTyping(chatId, santaId);
      };
      santaSendBtn.onclick = sendSantaMsg;
      santaInput.onkeydown = (e) => {
        if (e.key === 'Enter') sendSantaMsg();
      };

      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è –°–∞–Ω—Ç—ã
      santaInput.oninput = () => {
        startTyping(chatId, santaId);
      };
    }

    function renderUsersListWithActive(activeId) {
      const usersRef = db.ref('users');
      usersRef.once('value', (snapshot) => {
        const users = snapshot.val() || {};
        const filtered = Object.entries(users).filter(([id, u]) => u.name !== '–î–µ–¥ –ú–æ—Ä–æ–∑' && u.name);
        usersListDiv.innerHTML = '';
        filtered.sort((a, b) => (b[1].lastSeen || 0) - (a[1].lastSeen || 0));
        for (let [id, user] of filtered) {
          const item = document.createElement('div');
          item.className = `user-item ${id === activeId ? 'active' : ''}`;
          item.innerHTML = `<div class="user-name">${user.name}</div>
                            <div class="user-lastseen">${formatLastSeen(user.lastSeen)}</div>`;
          item.onclick = () => selectUserChat(id, user.name);
          usersListDiv.appendChild(item);
        }
      });
    }

    function appendMessageToSanta(type, text, timestamp, msgId, isSantaSender) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message', type);
      msgDiv.dataset.id = msgId;
      const deleteBtn = isSantaSender || !isSantaSender ? // –°–∞–Ω—Ç–∞ –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ª—é–±—ã–µ
        `<span class="delete-btn" data-id="${msgId}" data-chat="${selectedUserId}_${santaId}">üóëÔ∏è</span>` : '';
      msgDiv.innerHTML = `<div class="bubble">${text}<div class="time">${formatTime(timestamp)} ${deleteBtn}</div></div>`;
      santaMessagesDiv.appendChild(msgDiv);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
      if (deleteBtn) {
        msgDiv.querySelector('.delete-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          const msgId = e.target.dataset.id;
          const chat = e.target.dataset.chat;
          if (msgId && chat) {
            db.ref(`messages/${chat}/${msgId}`).remove();
          }
        });
      }
    }

    // ---------- –ò–Ω–¥–∏–∫–∞—Ü–∏—è –ø–µ—á–∞—Ç–∞–Ω–∏—è ----------
    function startTyping(chatId, userId) {
      const typingRef = db.ref(`typing/${chatId}/${userId}`);
      typingRef.set(true);
      clearTimeout(typingTimeouts[`${chatId}_${userId}`]);
      typingTimeouts[`${chatId}_${userId}`] = setTimeout(() => {
        typingRef.set(false);
      }, 2000);
    }

    function stopTyping(chatId, userId) {
      const typingRef = db.ref(`typing/${chatId}/${userId}`);
      typingRef.set(false);
      clearTimeout(typingTimeouts[`${chatId}_${userId}`]);
    }

    // ---------- –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ----------
    (async function() {
      const savedUserId = localStorage.getItem('santaChatUserId');
      const savedUserName = localStorage.getItem('santaChatUserName');
      const savedIsSanta = localStorage.getItem('santaChatIsSanta') === 'true';

      if (savedUserId && savedUserName) {
        // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const userSnap = await db.ref('users/' + savedUserId).once('value');
        if (userSnap.exists()) {
          await ensureSanta();
          initApp(savedUserName, savedUserId, savedIsSanta);
          return;
        } else {
          // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, –æ—á–∏—â–∞–µ–º localStorage
          localStorage.removeItem('santaChatUserId');
        }
      }
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
      welcomeScreen.classList.add('active-screen');
      appScreen.classList.remove('active-screen');
    })();

    // ---------- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞ ----------
    startBtn.addEventListener('click', async () => {
      const name = usernameInput.value.trim();
      if (!name) return;

      const user = await getOrCreateUser(name);
      const isSantaUser = (name.toLowerCase() === '–¥–µ–¥ –º–æ—Ä–æ–∑');
      initApp(user.name, user.id, isSantaUser);
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    function scrollToBottom(element) {
      element.scrollTop = element.scrollHeight;
    }
  })();
</script>
</body>
</html>
