<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>–î–µ–¥ –ú–æ—Ä–æ–∑ ‚Äî –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π —á–∞—Ç</title>
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(145deg, #0b1a3a 0%, #1b3b5c 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      position: relative;
      overflow-x: hidden;
    }
    /* –°–Ω–µ–∂–∏–Ω–∫–∏ (–ø—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è) */
    body::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.2"><path fill="white" d="M50 10 L53 30 L70 30 L57 42 L63 60 L50 50 L37 60 L43 42 L30 30 L47 30 Z" /></svg>');
      background-size: 80px 80px;
      animation: snow 20s linear infinite;
      pointer-events: none;
    }
    @keyframes snow {
      0% { background-position: 0 0; }
      100% { background-position: 0 400px; }
    }
    .app-container {
      width: 100%;
      max-width: 1300px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 48px;
      box-shadow: 0 25px 50px -8px rgba(0,0,0,0.4), 0 0 0 2px rgba(255,255,240,0.3);
      overflow: hidden;
      padding: 20px;
      transition: all 0.3s;
      border: 1px solid rgba(255,255,255,0.2);
    }
    /* –≠–ö–†–ê–ù –í–•–û–î–ê */
    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 500px;
      text-align: center;
      color: white;
    }
    .glowing-title {
      font-size: clamp(24px, 6vw, 44px);
      font-weight: 700;
      text-shadow: 0 0 10px #fff, 0 0 20px #ffd700, 0 0 30px #ff8c00, 0 0 40px #ff4d00;
      animation: glowPulse 2s infinite alternate;
      margin-bottom: 20px;
      line-height: 1.3;
    }
    @keyframes glowPulse {
      0% { text-shadow: 0 0 10px #fff, 0 0 20px #ffd700, 0 0 30px #ff8c00; }
      100% { text-shadow: 0 0 20px #fff, 0 0 30px #ffea00, 0 0 50px #ffaa00, 0 0 70px #ff6a00; }
    }
    .welcome-sub {
      font-size: 20px;
      margin: 25px 0 10px;
      font-weight: 400;
      color: #e0f2fe;
    }
    .name-input {
      width: 90%;
      max-width: 350px;
      padding: 16px 25px;
      border: none;
      border-radius: 60px;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(5px);
      color: white;
      font-size: 18px;
      outline: 2px solid #ffd966;
      margin: 15px 0 25px;
      text-align: center;
      transition: 0.2s;
    }
    .name-input::placeholder {
      color: rgba(255,255,255,0.7);
    }
    .name-input:focus {
      outline: 4px solid #ffb347;
      background: rgba(255,255,255,0.3);
    }
    .primary-btn {
      background: linear-gradient(135deg, #f6d5a3, #e6b87e);
      border: none;
      padding: 16px 50px;
      border-radius: 60px;
      font-size: 22px;
      font-weight: 700;
      color: #1e3c5c;
      box-shadow: 0 10px 25px #b95f1d, 0 0 20px #ffd966;
      cursor: pointer;
      transition: 0.2s;
      border: 2px solid #fff9e6;
    }
    .primary-btn:active { transform: scale(0.96); }

    /* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° (—Å–∫—Ä—ã—Ç –¥–æ –≤—Ö–æ–¥–∞) */
    .chat-interface {
      display: none;
      color: white;
    }
    /* —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–∏–Ω–∏–π) */
    .user-chat {
      display: flex;
      flex-direction: column;
      height: 75vh;
      min-height: 500px;
      background: rgba(0, 30, 60, 0.6);
      border-radius: 36px;
      padding: 20px;
      backdrop-filter: blur(10px);
      border: 2px solid #6ab0ff;
    }
    .chat-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #4682b4;
      font-size: 24px;
      font-weight: 600;
    }
    .chat-header i { font-size: 40px; }
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }
    /* —Å—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
    .message {
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 28px;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.2s;
    }
    .message.outgoing {
      align-self: flex-end;
      background: #1e4d7c;
      border-bottom-right-radius: 6px;
      color: white;
    }
    .message.incoming {
      align-self: flex-start;
      background: #2c3e50;
      border-bottom-left-radius: 6px;
      color: #f0f9ff;
    }
    .message .time {
      font-size: 11px;
      opacity: 0.7;
      margin-left: 10px;
      white-space: nowrap;
    }
    .message .delete-btn {
      margin-left: 12px;
      background: none;
      border: none;
      color: #ffaaaa;
      font-size: 18px;
      cursor: pointer;
      display: none;
    }
    .message:hover .delete-btn {
      display: inline-block;
    }
    /* —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã */
    .date-divider {
      text-align: center;
      margin: 15px 0 5px;
      font-size: 13px;
      color: #b0d4ff;
      background: rgba(255,255,255,0.1);
      padding: 6px 12px;
      border-radius: 40px;
      align-self: center;
      backdrop-filter: blur(4px);
    }
    .typing-indicator {
      font-size: 14px;
      color: #b0e0ff;
      padding: 6px 15px;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .typing-dots span {
      width: 8px; height: 8px;
      background: white;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
      animation: blink 1.4s infinite;
    }
    @keyframes blink { 50% { opacity: 0.3; } }
    .input-area {
      display: flex;
      gap: 12px;
      margin-top: 15px;
      background: rgba(0,0,0,0.3);
      padding: 10px 20px;
      border-radius: 60px;
    }
    .input-area input {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      outline: none;
    }
    .input-area button {
      background: #ffb054;
      border: none;
      border-radius: 40px;
      padding: 12px 25px;
      font-weight: 600;
      color: #012;
      cursor: pointer;
    }
    /* –†–ï–ñ–ò–ú –î–ï–î–ê –ú–û–†–û–ó–ê (–∫—Ä–∞—Å–Ω—ã–π) */
    .santa-panel {
      display: flex;
      flex-direction: row;
      gap: 20px;
      height: 75vh;
      min-height: 550px;
    }
    .users-sidebar {
      width: 280px;
      background: #5b1e1e;
      border-radius: 36px;
      padding: 15px;
      overflow-y: auto;
      border: 3px solid #d4a373;
      box-shadow: inset 0 0 15px #3b0a0a;
    }
    .users-sidebar h3 {
      color: #ffdfbf;
      text-align: center;
      border-bottom: 2px solid #d48d6e;
      padding-bottom: 12px;
      margin-bottom: 15px;
    }
    .user-item {
      background: #842020;
      padding: 15px 18px;
      margin-bottom: 12px;
      border-radius: 40px;
      cursor: pointer;
      border: 2px solid #eba35b;
      transition: 0.1s;
      color: #fbe9d2;
      font-weight: 600;
    }
    .user-item.active {
      background: #b13e3e;
      border-color: #ffc857;
      box-shadow: 0 0 15px #ffa500;
    }
    .user-item .last-seen {
      font-size: 12px;
      color: #ffdba5;
      font-weight: 400;
    }
    .user-item .typing-tag {
      color: #b3ffaa;
      font-size: 13px;
      font-weight: 400;
      margin-left: 6px;
    }
    .santa-chat-area {
      flex: 1;
      background: #611f1f;
      border-radius: 36px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      border: 3px solid #d4a373;
    }
    .santa-chat-header {
      display: flex;
      justify-content: space-between;
      padding-bottom: 12px;
      border-bottom: 2px solid #b17b5e;
    }
    .back-to-users {
      display: none;
      background: #a14444;
      border: none;
      color: white;
      padding: 8px 20px;
      border-radius: 40px;
      font-weight: 600;
    }
    @media (max-width: 700px) {
      .santa-panel { flex-direction: column; }
      .users-sidebar { width: 100%; max-height: 180px; }
      .back-to-users { display: inline-block; }
    }
    /* –û–±—â–∏–π —Å–∫—Ä–æ–ª–ª */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #d4a373; border-radius: 10px; }
  </style>
</head>
<body>
<div class="app-container" id="appContainer">
  <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
  <div id="welcomeScreen" class="welcome-screen">
    <div class="glowing-title">‚ú® –ù–∞—á–Ω–∏ –æ–±—â–µ–Ω–∏–µ —Å –î–µ–¥–æ–º –ú–æ—Ä–æ–∑–æ–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! ‚ú®</div>
    <div class="welcome-sub">–ù–∞–ø–∏—à–∏ —Å–≤–æ—ë –∏–º—è:</div>
    <input type="text" id="userNameInput" class="name-input" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–∞—à–∞" autocomplete="off">
    <button class="primary-btn" id="startChatBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
  </div>

  <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–∏–Ω–∏–π —á–∞—Ç) -->
  <div id="userChatInterface" class="chat-interface">
    <div class="user-chat">
      <div class="chat-header">
        <span>üéÖ –ß–∞—Ç —Å –î–µ–¥–æ–º –ú–æ—Ä–æ–∑–æ–º</span>
        <span style="font-size: 16px; margin-left: auto;" id="userNameDisplay"></span>
      </div>
      <div id="userMessages" class="messages-area"></div>
      <div id="userTypingIndicator" class="typing-indicator" style="display: none;">
        <span>üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ –ø–µ—á–∞—Ç–∞–µ—Ç</span>
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>
      <div class="input-area">
        <input type="text" id="userMessageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button id="sendUserBtn">‚ùÑÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (–∫—Ä–∞—Å–Ω—ã–π) -->
  <div id="santaInterface" class="chat-interface">
    <div class="santa-panel">
      <div class="users-sidebar" id="usersSidebar">
        <h3>üéÅ –î–æ–±—Ä—ã–µ –¥–µ—Ç–∏</h3>
        <div id="usersList"></div>
      </div>
      <div class="santa-chat-area" id="santaChatArea">
        <div class="santa-chat-header">
          <span id="selectedUserName">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
          <button class="back-to-users" id="backToUsersBtn" style="display: none;">‚Üê –ö —Å–ø–∏—Å–∫—É</button>
        </div>
        <div id="santaMessages" class="messages-area"></div>
        <div id="santaTypingIndicator" class="typing-indicator" style="display: none;">
          <span id="santaTypingText">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç</span>
          <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
        <div class="input-area">
          <input type="text" id="santaMessageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç..." autocomplete="off" disabled>
          <button id="sendSantaBtn" disabled>üéÑ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // -------------------- Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è --------------------
  const firebaseConfig = {
    apiKey: "AIzaSyAu_wfaRhTsWNbsyFYmEigopqJck7ynxlU",
    authDomain: "messeger-0wo2h4.firebaseapp.com",
    databaseURL: "https://messeger-0wo2h4-default-rtdb.firebaseio.com",
    projectId: "messeger-0wo2h4",
    storageBucket: "messeger-0wo2h4.firebasestorage.app",
    messagingSenderId: "1057251395030",
    appId: "1:1057251395030:web:86f8f718ed938055e29077"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // -------------------- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ --------------------
  let currentUserId = null;          // –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —é–∑–µ—Ä–∞ —ç—Ç–æ –µ–≥–æ ID, –¥–ª—è –°–∞–Ω—Ç—ã = "santa"
  let currentUserName = null;
  let isSanta = false;
  let selectedChatUserId = null;      // –¥–ª—è –°–∞–Ω—Ç—ã –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  let typingTimeouts = {};

  // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
  const welcomeScreen = document.getElementById('welcomeScreen');
  const userInterface = document.getElementById('userChatInterface');
  const santaInterface = document.getElementById('santaInterface');
  const userNameInput = document.getElementById('userNameInput');
  const startBtn = document.getElementById('startChatBtn');
  const userNameDisplay = document.getElementById('userNameDisplay');
  const userMessagesDiv = document.getElementById('userMessages');
  const userMsgInput = document.getElementById('userMessageInput');
  const sendUserBtn = document.getElementById('sendUserBtn');
  const userTypingIndicator = document.getElementById('userTypingIndicator');

  // –°–∞–Ω—Ç–∞ —ç–ª–µ–º–µ–Ω—Ç—ã
  const usersListDiv = document.getElementById('usersList');
  const santaMessagesDiv = document.getElementById('santaMessages');
  const santaMsgInput = document.getElementById('santaMessageInput');
  const sendSantaBtn = document.getElementById('sendSantaBtn');
  const selectedUserNameSpan = document.getElementById('selectedUserName');
  const santaTypingIndicator = document.getElementById('santaTypingIndicator');
  const santaTypingText = document.getElementById('santaTypingText');
  const backToUsersBtn = document.getElementById('backToUsersBtn');

  // -------------------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ --------------------
  function formatMessageTime(timestamp) {
    if (!timestamp) return '';
    const d = new Date(timestamp);
    const now = new Date();
    const mskOffset = 3 * 60 * 60 * 1000; // +3 –¥–ª—è –ú–°–ö
    const dMsk = new Date(d.getTime() + mskOffset);
    const nowMsk = new Date(now.getTime() + mskOffset);

    const isToday = dMsk.toDateString() === nowMsk.toDateString();
    const isYesterday = new Date(nowMsk - 86400000).toDateString() === dMsk.toDateString();

    let datePart = '';
    if (isToday) datePart = '—Å–µ–≥–æ–¥–Ω—è';
    else if (isYesterday) datePart = '–≤—á–µ—Ä–∞';
    else datePart = dMsk.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });

    const timeStr = dMsk.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    return `${datePart} –≤ ${timeStr}`;
  }

  function formatLastSeen(timestamp) {
    if (!timestamp) return '–Ω–∏–∫–æ–≥–¥–∞';
    const now = Date.now();
    const diff = now - timestamp;
    const minute = 60 * 1000;
    const hour = 60 * minute;
    const day = 24 * hour;

    if (diff < 30 * 1000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diff < minute) return '–º–µ–Ω–µ–µ –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥';
    if (diff < hour) return Math.floor(diff / minute) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (diff < day) return Math.floor(diff / hour) + ' —á –Ω–∞–∑–∞–¥';
    if (diff < 2 * day) return '–≤—á–µ—Ä–∞ –≤ ' + new Date(timestamp + 3*3600000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    return new Date(timestamp + 3*3600000).toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' }) + ' –≤ ' + 
           new Date(timestamp + 3*3600000).toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' });
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  (function loadSession() {
    const storedId = localStorage.getItem('chatUserId');
    const storedName = localStorage.getItem('chatUserName');
    const storedSanta = localStorage.getItem('chatIsSanta') === 'true';
    if (storedId && storedName) {
      if (storedSanta) {
        isSanta = true;
        currentUserId = 'santa';
        currentUserName = '–î–µ–¥ –ú–æ—Ä–æ–∑';
        initSanta();
      } else {
        isSanta = false;
        currentUserId = storedId;
        currentUserName = storedName;
        initUser();
      }
    }
  })();

  // -------------------- –í—Ö–æ–¥ / —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è --------------------
  startBtn.addEventListener('click', async () => {
    const name = userNameInput.value.trim();
    if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
    if (name === '–î–µ–¥ –ú–æ—Ä–æ–∑') {
      // –í–æ–π—Ç–∏ –∫–∞–∫ –î–µ–¥ –ú–æ—Ä–æ–∑
      currentUserId = 'santa';
      currentUserName = '–î–µ–¥ –ú–æ—Ä–æ–∑';
      isSanta = true;
      // –ø—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å santa –≤ –±–∞–∑–µ, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–¥–∏–º
      const snapshot = await db.ref('users/santa').once('value');
      if (!snapshot.exists()) {
        await db.ref('users/santa').set({ name: '–î–µ–¥ –ú–æ—Ä–æ–∑', isSanta: true, lastSeen: firebase.database.ServerValue.TIMESTAMP });
      } else {
        await db.ref('users/santa/lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
      }
      localStorage.setItem('chatUserId', 'santa');
      localStorage.setItem('chatUserName', '–î–µ–¥ –ú–æ—Ä–æ–∑');
      localStorage.setItem('chatIsSanta', 'true');
      initSanta();
    } else {
      // –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      const newUserRef = db.ref('users').push();
      const userId = newUserRef.key;
      await newUserRef.set({
        name: name,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
      });
      currentUserId = userId;
      currentUserName = name;
      isSanta = false;
      localStorage.setItem('chatUserId', userId);
      localStorage.setItem('chatUserName', name);
      localStorage.setItem('chatIsSanta', 'false');
      initUser();
    }
  });

  // -------------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --------------------
  function initUser() {
    welcomeScreen.style.display = 'none';
    userInterface.style.display = 'block';
    santaInterface.style.display = 'none';
    userNameDisplay.textContent = currentUserName;

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ chats/{userId}/messages
    const messagesRef = db.ref(`chats/${currentUserId}/messages`).orderByChild('timestamp');
    messagesRef.off();
    messagesRef.on('value', (snapshot) => {
      const msgs = snapshot.val();
      renderUserMessages(msgs);
      scrollToBottom(userMessagesDiv);
    });

    // –°–ª—É—à–∞–µ–º –ø–µ—á–∞—Ç–∞–Ω–∏–µ –æ—Ç –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (typing/{userId}/santa)
    const typingRef = db.ref(`typing/${currentUserId}/santa`);
    typingRef.off();
    typingRef.on('value', (snap) => {
      if (snap.val()) {
        userTypingIndicator.style.display = 'flex';
      } else {
        userTypingIndicator.style.display = 'none';
      }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º lastSeen –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    db.ref(`users/${currentUserId}/lastSeen`).set(firebase.database.ServerValue.TIMESTAMP);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    sendUserBtn.onclick = sendUserMessage;
    userMsgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendUserMessage(); });
    userMsgInput.addEventListener('input', handleUserTyping);
  }

  function sendUserMessage() {
    const text = userMsgInput.value.trim();
    if (!text) return;
    const msgRef = db.ref(`chats/${currentUserId}/messages`).push();
    msgRef.set({
      from: currentUserId,
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
      userMsgInput.value = '';
      // —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∞–Ω–∏—è
      db.ref(`typing/santa/${currentUserId}`).remove();
      // –æ–±–Ω–æ–≤–ª—è–µ–º lastSeen
      db.ref(`users/${currentUserId}/lastSeen`).set(firebase.database.ServerValue.TIMESTAMP);
    });
  }

  let typingTimer;
  function handleUserTyping() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—á–∞—Ç–∞–Ω–∏—è –¥–ª—è –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
    db.ref(`typing/santa/${currentUserId}`).set(firebase.database.ServerValue.TIMESTAMP);
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      db.ref(`typing/santa/${currentUserId}`).remove();
    }, 3000);
  }

  function renderUserMessages(msgs) {
    if (!msgs) { userMessagesDiv.innerHTML = ''; return; }
    let html = '';
    const sorted = Object.entries(msgs).sort((a,b) => a[1].timestamp - b[1].timestamp);
    let lastDate = null;
    for (let [id, msg] of sorted) {
      const msgDate = new Date(msg.timestamp + 3*3600000).toDateString();
      if (msgDate !== lastDate) {
        const displayDate = formatMessageTime(msg.timestamp).split(' –≤ ')[0];
        html += `<div class="date-divider">‚ùÑÔ∏è ${displayDate} ‚ùÑÔ∏è</div>`;
        lastDate = msgDate;
      }
      const isMine = msg.from === currentUserId;
      html += `<div class="message ${isMine ? 'outgoing' : 'incoming'}" data-id="${id}">`;
      html += `<span>${msg.text}</span>`;
      html += `<span class="time">${formatMessageTime(msg.timestamp)}</span>`;
      html += `</div>`;
    }
    userMessagesDiv.innerHTML = html;
  }

  // -------------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ --------------------
  function initSanta() {
    welcomeScreen.style.display = 'none';
    userInterface.style.display = 'none';
    santaInterface.style.display = 'block';
    currentUserId = 'santa';
    isSanta = true;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Å–µ, –∫—Ä–æ–º–µ santa)
    const usersRef = db.ref('users');
    usersRef.off();
    usersRef.on('value', (snap) => {
      const users = snap.val();
      renderUsersList(users);
    });

    // –°–ª—É—à–∞–µ–º –ø–µ—á–∞—Ç–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (typing/santa)
    const typingSantaRef = db.ref('typing/santa');
    typingSantaRef.off();
    typingSantaRef.on('value', (snap) => {
      // –û–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å "–ø–µ—á–∞—Ç–∞–µ—Ç"
      highlightTypingUsers(snap.val());
    });

    // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    backToUsersBtn.addEventListener('click', () => {
      selectedChatUserId = null;
      document.querySelector('.users-sidebar').style.display = 'block';
      santaMessagesDiv.innerHTML = ''; 
      selectedUserNameSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
      santaMsgInput.disabled = true;
      sendSantaBtn.disabled = true;
    });
  }

  function renderUsersList(users) {
    if (!users) return;
    let html = '';
    const sorted = Object.entries(users).filter(([id]) => id !== 'santa').sort((a,b) => (b[1].lastSeen || 0) - (a[1].lastSeen || 0));
    for (let [id, user] of sorted) {
      const lastSeenStr = formatLastSeen(user.lastSeen);
      const typingClass = (window.typingUsers && window.typingUsers[id]) ? 'typing-tag' : '';
      const typingText = (window.typingUsers && window.typingUsers[id]) ? ' ‚úçÔ∏è –ø–µ—á–∞—Ç–∞–µ—Ç...' : '';
      html += `<div class="user-item ${selectedChatUserId === id ? 'active' : ''}" data-userid="${id}">
        <div>‚ùÑÔ∏è ${user.name} <span class="last-seen">${lastSeenStr}</span><span class="typing-tag">${typingText}</span></div>
      </div>`;
    }
    usersListDiv.innerHTML = html;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞
    document.querySelectorAll('.user-item').forEach(el => {
      el.addEventListener('click', () => {
        const uid = el.dataset.userid;
        selectUserChat(uid);
      });
    });
  }

  let typingUsers = {};
  function highlightTypingUsers(typingData) {
    typingUsers = typingData || {};
    // –æ–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫, –¥–æ–±–∞–≤–∏–≤ –∏–Ω–¥–∏–∫–∞—Ü–∏—é
    const userItems = document.querySelectorAll('.user-item');
    userItems.forEach(item => {
      const uid = item.dataset.userid;
      const span = item.querySelector('.typing-tag');
      if (span) {
        if (typingUsers[uid]) span.textContent = ' ‚úçÔ∏è –ø–µ—á–∞—Ç–∞–µ—Ç...';
        else span.textContent = '';
      }
    });
  }

  function selectUserChat(userId) {
    selectedChatUserId = userId;
    // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∏–º—è
    db.ref('users/' + userId).once('value', (snap) => {
      const user = snap.val();
      selectedUserNameSpan.textContent = user ? user.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    });
    // –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    santaMsgInput.disabled = false;
    sendSantaBtn.disabled = false;
    // –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫
    if (window.innerWidth <= 700) {
      document.querySelector('.users-sidebar').style.display = 'none';
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
    const msgsRef = db.ref(`chats/${userId}/messages`).orderByChild('timestamp');
    msgsRef.off();
    msgsRef.on('value', (snap) => {
      renderSantaMessages(snap.val(), userId);
      scrollToBottom(santaMessagesDiv);
    });

    // –°–ª—É—à–∞–µ–º –ø–µ—á–∞—Ç–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (typing/santa/${userId})
    const typingUserRef = db.ref(`typing/santa/${userId}`);
    typingUserRef.off();
    typingUserRef.on('value', (snap) => {
      if (snap.val()) {
        santaTypingText.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç...';
        santaTypingIndicator.style.display = 'flex';
      } else {
        santaTypingIndicator.style.display = 'none';
      }
    });
  }

  function renderSantaMessages(msgs, chatUserId) {
    if (!msgs) { santaMessagesDiv.innerHTML = ''; return; }
    let html = '';
    const sorted = Object.entries(msgs).sort((a,b) => a[1].timestamp - b[1].timestamp);
    let lastDate = null;
    for (let [id, msg] of sorted) {
      const msgDate = new Date(msg.timestamp + 3*3600000).toDateString();
      if (msgDate !== lastDate) {
        const displayDate = formatMessageTime(msg.timestamp).split(' –≤ ')[0];
        html += `<div class="date-divider">üéÖ ${displayDate} üéÖ</div>`;
        lastDate = msgDate;
      }
      const isSanta = msg.from === 'santa';
      html += `<div class="message ${isSanta ? 'outgoing' : 'incoming'}" data-id="${id}">`;
      html += `<span>${msg.text}</span>`;
      html += `<span class="time">${formatMessageTime(msg.timestamp)}</span>`;
      html += `<button class="delete-btn" data-userid="${chatUserId}" data-msgid="${id}">üóëÔ∏è</button>`;
      html += `</div>`;
    }
    santaMessagesDiv.innerHTML = html;

    // –Ω–∞–≤–µ—Å–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const userId = btn.dataset.userid;
        const msgId = btn.dataset.msgid;
        db.ref(`chats/${userId}/messages/${msgId}`).remove();
      });
    });
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –°–∞–Ω—Ç—ã
  sendSantaBtn.addEventListener('click', sendSantaMessage);
  santaMsgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendSantaMessage(); });
  santaMsgInput.addEventListener('input', handleSantaTyping);

  function sendSantaMessage() {
    if (!selectedChatUserId) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    const text = santaMsgInput.value.trim();
    if (!text) return;
    const msgRef = db.ref(`chats/${selectedChatUserId}/messages`).push();
    msgRef.set({
      from: 'santa',
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
      santaMsgInput.value = '';
      db.ref(`typing/${selectedChatUserId}/santa`).remove(); // —É–±–∏—Ä–∞–µ–º —Å–≤–æ–π –Ω–∞–±–æ—Ä
      db.ref('users/santa/lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
    });
  }

  let santaTypingTimer;
  function handleSantaTyping() {
    if (!selectedChatUserId) return;
    db.ref(`typing/${selectedChatUserId}/santa`).set(firebase.database.ServerValue.TIMESTAMP);
    clearTimeout(santaTypingTimer);
    santaTypingTimer = setTimeout(() => {
      db.ref(`typing/${selectedChatUserId}/santa`).remove();
    }, 3000);
  }

  function scrollToBottom(container) {
    setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ lastSeen –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  window.addEventListener('beforeunload', function() {
    if (currentUserId) {
      db.ref(`users/${currentUserId}/lastSeen`).set(firebase.database.ServerValue.TIMESTAMP);
    }
  });
</script>
</body>
</html>
